# Phase 4: ダウンロード後ガイド機能 - 実装サマリー

**作成日:** 2026-02-12
**最終更新:** 2026-02-12
**実装担当:** Haiku + Sonnet 4.5
**優先度:** 高
**工数見積:** 11-16時間
**実装状況:** ✅ Phase 4.1 完了

---

## 📋 実装概要

ZIPファイルダウンロード完了後に表示する、OBS手動設定ガイド機能の実装。
basic.ini/service.jsonでは設定できない10項目を、初心者向けに画像（またはテキスト）付きで案内します。

---

## 🎯 実装目標

1. **初心者の離脱を防ぐ**
   - 設定ファイルをダウンロードしただけで満足してしまうのを防ぐ

2. **必須設定の漏れを防ぐ**
   - YouTube配信キー、マイク、ゲームキャプチャなど、必ず設定が必要な項目を明示

3. **パフォーマンス最適化を支援**
   - 初心者でもワンクリックで選択できるよう、影響度を明示したチェックボックス形式

---

## 📊 実装項目（10項目）

### ✅ 必須設定（3項目）

| No | 項目名 | 必須度 | 影響度 | 推定時間 |
|----|--------|--------|--------|----------|
| 1 | YouTube配信キーの設定 | ★★★★★ | - | 120秒 |
| 2 | マイク音声の設定 | ★★★★★ | 🟢 小 | 60秒 |
| 3 | ゲームキャプチャの追加 | ★★★★★ | 🟡 中 | 180秒 |

### ⚡ パフォーマンス設定（影響度: 大）（3項目）

| No | 項目名 | 必須度 | 影響度 | 効果 | 推定時間 |
|----|--------|--------|--------|------|----------|
| 4 | プレビュー画面の無効化 | ★★☆☆☆ | 🔴 大 | CPU -10-15% | 10秒 |
| 5 | プロセス優先度の設定 | ★★★☆☆ | 🔴 大 | コマ落ち防止 | 30秒 |
| 6 | 自動録画の無効化 | ★★☆☆☆ | 🔴 大 | ディスク負荷削減 | 30秒 |

### 🔧 その他の最適化（4項目）

| No | 項目名 | 必須度 | 影響度 | 推定時間 |
|----|--------|--------|--------|----------|
| 7 | 出力モードの確認 | ★★★☆☆ | 🟡 中 | 60秒 |
| 8 | Windowsゲームモード | ★★★☆☆ | 🟡 中 | 30秒 |
| 9 | ブラウザHWアクセラ | ★☆☆☆☆ | 🟢 小 | 45秒 |
| 10 | 音声モニタリング | ★★★☆☆ | 🟢 小 | 45秒 |

---

## 🏗️ 実装構成

### ファイル構成

```
components/
├── post-download/
│   ├── guide-complete.tsx         # 完了画面（拡張版）
│   ├── guide-required.tsx         # 必須設定ガイド
│   ├── guide-performance.tsx      # パフォーマンス設定ガイド
│   ├── guide-optional.tsx         # 詳細設定ガイド
│   └── guide-item.tsx             # ガイド項目コンポーネント

lib/
├── post-download-guide.ts         # ガイドデータ定義（10項目）
└── types.ts                       # 型定義追加

components/desktop/
└── desktop-view.tsx               # 完了画面からガイドへの遷移追加

data/
└── guide-images/                  # 画像格納（将来実装）
    ├── youtube-stream-key.png
    ├── microphone-setup.png
    └── ...
```

### 型定義

```typescript
// lib/types.ts に追加

/**
 * ガイド項目のカテゴリ
 */
export type GuideCategory =
  | 'required'
  | 'performance-high'
  | 'performance-mid'
  | 'optional';

/**
 * パフォーマンス影響度
 */
export type PerformanceImpact = 'high' | 'medium' | 'low' | 'none';

/**
 * ガイド項目の詳細
 */
export interface GuideItem {
  id: string;
  title: string;
  category: GuideCategory;
  priority: number; // 1-5 (5が最重要)
  impact: PerformanceImpact;
  impactDescription?: string; // 例: "CPU -10-15%"
  description: string;
  steps: string[]; // 手順のリスト
  imageUrl?: string; // 画像URL（将来実装）
  imagePlaceholder?: string; // 画像の代替テキスト（ASCII図など）
  estimatedTime?: number; // 設定にかかる推定時間（秒）
  completed?: boolean; // ユーザーが完了マークを付けたか
}

/**
 * ガイド進捗状態
 */
export interface GuideProgress {
  requiredCompleted: number; // 必須設定の完了数
  performanceSelected: string[]; // 選択されたパフォーマンス設定のID
  optionalCompleted: number; // 任意設定の完了数
  currentStep: 'required' | 'performance' | 'optional' | 'complete';
}
```

---

## 🎨 UI設計

### 完了画面（拡張版）

```
┌─────────────────────────────────────┐
│ 🎉 設定ファイルのダウンロード完了！   │
├─────────────────────────────────────┤
│ ZIPファイル: obs-config-xxxxx.zip   │
│ サイズ: 1.6 KB                       │
│                                     │
│ 次のステップ: OBSで手動設定          │
│                                     │
│ [📥 ZIPファイルのインポート方法]     │
│ [⚙️ 必須設定ガイドを見る] ← 推奨     │
│                                     │
│ [最初に戻る]                         │
└─────────────────────────────────────┘
```

### 必須設定ガイド画面

```
┌─────────────────────────────────────┐
│ ✅ 必須設定（配信前に必ず設定）       │
├─────────────────────────────────────┤
│ 以下の3つは必ず設定してください       │
│ 設定しないと配信を開始できません      │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 1️⃣ YouTube配信キーの設定             │
│                                     │
│ 【説明】                             │
│ YouTube Liveの配信キーを設定しないと │
│ 配信を開始できません。               │
│                                     │
│ 推定時間: 2分                        │
│                                     │
│ [📸 画像で見る] [📝 テキストで見る]   │
│                                     │
│ ☐ 設定完了                          │
└─────────────────────────────────────┘

（2, 3も同様）

┌─────────────────────────────────────┐
│ 進捗: 0/3 完了                       │
│                                     │
│ [次へ: パフォーマンス設定]             │
└─────────────────────────────────────┘
```

---

## 📝 実装手順

### Phase 4.1: 必須設定ガイド（4-6時間）

1. **型定義の追加**
   - `lib/types.ts` に `GuideItem`, `GuideProgress` などを追加

2. **ガイドデータの作成**
   - `lib/post-download-guide.ts` を作成
   - 10項目のガイドデータを定義（手順テキスト、Placeholder含む）

3. **ガイド項目コンポーネント**
   - `components/post-download/guide-item.tsx` を作成
   - 手順の展開/折りたたみ
   - 完了チェック機能
   - 画像/テキスト切り替え（将来実装）

4. **必須設定ガイド画面**
   - `components/post-download/guide-required.tsx` を作成
   - 3項目の必須設定を表示
   - 進捗バー表示
   - 「次へ」ボタン

5. **完了画面の拡張**
   - `components/post-download/guide-complete.tsx` を作成
   - 「必須設定ガイドを見る」ボタン追加
   - 「ZIPファイルのインポート方法」モーダル

6. **DesktopViewの統合**
   - `components/desktop/desktop-view.tsx` を修正
   - `complete` ステップで `GuideComplete` コンポーネントを表示
   - ガイド画面への遷移実装

### Phase 4.2: パフォーマンス設定ガイド（3-4時間）

1. **パフォーマンス設定画面**
   - `components/post-download/guide-performance.tsx` を作成
   - 3項目のパフォーマンス設定を表示
   - チェックボックスで選択可能
   - 影響度の視覚化（🔴🟡🟢）
   - 「詳細設定を見る」「スキップして完了」ボタン

2. **進捗管理**
   - `useState` で `GuideProgress` を管理
   - チェック状態の保存
   - 完了数のカウント

### Phase 4.3: 詳細設定ガイド（2-3時間）

1. **詳細設定画面**
   - `components/post-download/guide-optional.tsx` を作成
   - 4項目の詳細設定を表示
   - 同様にチェックボックスで選択可能
   - 「完了」ボタン

2. **全体フロー統合**
   - 必須 → パフォーマンス → 詳細 → 完了のフロー実装
   - スキップ機能の実装
   - 戻るボタン（任意）

### Phase 4.4: テスト・調整（2-3時間）

1. **動作確認**
   - 各画面の遷移確認
   - チェック機能の動作確認
   - レスポンシブデザイン確認

2. **UI/UX調整**
   - フォントサイズ調整（初心者向けに大きく）
   - スペーシング調整
   - カラー調整

---

## 🎯 実装優先度

| Phase | 内容 | 優先度 | 工数 |
|-------|------|--------|------|
| Phase 4.1 | 必須設定ガイド（3項目） | 🔴 高 | 4-6h |
| Phase 4.2 | パフォーマンス設定（3項目） | 🟡 高 | 3-4h |
| Phase 4.3 | 詳細設定（4項目） | 🟢 中 | 2-3h |
| テスト | 動作確認・調整 | 🟡 高 | 2-3h |

**合計:** 11-16時間

---

## ✅ 実装完了条件

- [ ] 10項目のガイドデータが定義されている
- [ ] 必須設定ガイド画面が動作する
- [ ] パフォーマンス設定ガイド画面が動作する
- [ ] 詳細設定ガイド画面が動作する
- [ ] 完了画面から各ガイドに遷移できる
- [ ] チェック機能が動作する
- [ ] 進捗バーが表示される
- [ ] 影響度が視覚化されている（🔴🟡🟢）
- [ ] スキップ機能が動作する
- [ ] レスポンシブデザインになっている
- [ ] フォントサイズが初心者向けに大きい

---

## 📚 参考ドキュメント

- **詳細仕様:** `docs/POST_DOWNLOAD_GUIDE.md`
- **UI仕様:** `docs/lv1/ui-spec.md` (Section 8)
- **実装計画:** `docs/lv1/implementation-plan.md` (Phase 4)
- **進捗管理:** `docs/IMPLEMENTATION_PROGRESS.md`

---

## 💡 実装のポイント

### 1. 初心者向けUI
- フォントサイズは `text-2xl` 以上（大きく）
- 専門用語を避ける
- 手順は5ステップ以内
- 影響度は絵文字で視覚化（🔴大 🟡中 🟢小）

### 2. 段階的実装
- まずはテキストPlaceholderで実装
- 画像は後から追加可能
- スキップ機能で柔軟性を確保

### 3. 完了感の演出
- チェックボックスで完了管理
- 進捗バーで達成感
- 推定時間を表示して安心感

### 4. パフォーマンス考慮
- 画像は遅延ロード（将来実装時）
- コンポーネントの適切な分割
- 状態管理はローカルstate（Redux不要）

---

## 🔧 GPU検出機能の修正（Phase 4.1追加実装）

### 問題の発見
Phase 4.1実装中に、GPU検出が正常に動作していないことが判明：
- **症状**: RTX 3060 Ti が「NVIDIA (Generic)」として検出される
- **原因**: GPU DBに「Ti」バリアントが未登録 + マッピングロジックが不十分

### 実施した修正

#### 1. GPU DB の拡張
- **追加モデル数**: 38 → 64モデル（+26モデル）
- **追加内容**:
  - RTX 30/40/50シリーズの全Tiバリアント
  - Super, Ti Super, D バリアント
  - GTX 16シリーズのTi/Superバリアント
  - スペースなし版（「RTX3060Ti」など）

#### 2. 正規化ロジックの改善
`lib/gpu-detector.ts` の `normalizeGpuName()` 関数を強化：
```typescript
// 追加処理
- 複数スペースを単一スペースに統一
- Ti/Super/Ultra等のサフィックスのスペース処理統一
- より確実な正規表現パターン
```

#### 3. マッピングロジックの再実装
4段階検索アルゴリズムを実装：
```
① 完全一致検索（従来通り）
② モデル番号による部分一致検索（NEW）
   → "3060 Ti" だけで正確にマッチ
③ あいまい検索（threshold 0.5に緩和）
④ ベンダー判定フォールバック
```

**モデル番号抽出の仕組み:**
```typescript
// 例: "ANGLE (NVIDIA GeForce RTX 3060 Ti Direct3D11)"
// → "3060" + "Ti" を抽出
// → DB内の "3060 Ti" を持つGPUを検索
```

#### 4. デバッグ機能の追加
- コンソールログに詳細情報を出力
- UI上に「検出詳細（デバッグ）」セクションを追加
- Raw Name、正規化後、マッピング結果を可視化

### 修正結果
✅ **RTX 3060 Ti が信頼度 85% で正確に検出**
- WebGL Raw: `ANGLE (NVIDIA, NVIDIA GeForce RTX 3060 Ti ...)`
- Normalized: `NVIDIA GeForce RTX 3060 Ti`
- Matched: `NVIDIA GeForce RTX 3060 Ti`
- Confidence: `85%`

### 修正ファイル
- `lib/gpu-detector.ts` - マッピングロジック再実装
- `lib/gpu-detector-client.ts` - 正規化処理改善
- `components/desktop/gpu-detector.tsx` - デバッグUI追加
- `scripts/init-db.js` - GPU DB拡張
- `scripts/reset-gpu-db.js` - DB強制リセット用スクリプト（新規）
- `scripts/add-gpu-variants.js` - バリアント追加スクリプト（新規）

### 技術的な学び
1. **WebGLから返されるGPU名の形式は多様**
   - ANGLE wrapper、Direct3D接尾辞、スペース変動
   - 正規化処理の重要性

2. **完全一致だけでは不十分**
   - モデル番号による部分一致が有効
   - あいまい検索は補助的に使用

3. **デバッグ機能は必須**
   - ユーザー環境での問題診断に不可欠
   - コンソールログ + UI表示の両方が重要

---

## 🚀 次のステップ（Phase 4.2～4.4）

### Phase 4.2: UIの微調整（2-3時間）
1. **フォント・色・スペーシング調整**
   - 初心者向けに見やすさ最優先
   - コントラスト比の確認（WCAG AA準拠）
2. **案内文言の見直し**
   - より分かりやすい日本語表現
   - 専門用語の補足説明追加
3. **ボタン配置の最適化**
   - アクセシビリティ向上
   - タッチデバイス対応

### Phase 4.3: 画像の置き換え（3-4時間）
1. **OBSスクリーンショット撮影**
   - 各ガイド項目（10個）のスクリーンショット
   - 重要な箇所を赤枠で強調
2. **ASCII placeholderを実際の画像に置き換え**
   - `/public/guide-images/` に配置
   - 画像パスを `GuideItem` に追加
3. **画像最適化**
   - WebP形式への変換（fallback PNG）
   - 遅延ロード実装
   - 適切な解像度（1280x720推奨）

### Phase 4.4: 最終調整（2-3時間）
1. **エラーハンドリング強化**
   - ネットワークエラー時の再試行
   - タイムアウト処理
2. **ローディング状態の改善**
   - スケルトンUI追加
   - プログレスバーのアニメーション
3. **アクセシビリティ確認**
   - キーボードナビゲーション
   - スクリーンリーダー対応
   - ARIA属性の追加

### Phase 5: α版デプロイ（準備完了後）
- 全機能の統合テスト
- パフォーマンステスト
- デプロイ設定

---

## 📊 実装統計

### Phase 4.1 完了時点
- **新規作成ファイル**: 8ファイル
- **修正ファイル**: 7ファイル
- **合計追加行数**: 約1,500行
- **GPU DBモデル数**: 64モデル
- **実装時間**: 約12時間

### コード品質
- ✅ TypeScript strict mode準拠
- ✅ ESLint エラーなし
- ✅ Next.js production build成功
- ✅ 全コンポーネント正常動作

---

**作成者:** Claude Sonnet 4.5
**実装担当:** Haiku + Sonnet 4.5
**Phase 4.1 完了日:** 2026-02-12
**最終更新:** 2026-02-12
